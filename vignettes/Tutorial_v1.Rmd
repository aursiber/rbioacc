---
title: "rbioacc Tutorial"
output: 
  rmarkdown::html_vignette:
    toc: TRUE
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation

From the GITLab repository (<https://gitlab.in2p3.fr/sandrine.charles/rbioacc>), download a clone archive folder. Extract it on your computer and create a new R project in this repository. Then open this R project, go to the right panel, in the `Build` tab, and click on `Check`. If there is no error, you can click on `Install and Restart`.

## Loading the package `rbioacc`

After the installation, you can now load the `rbioacc` package:

```{r setup}
library(rbioacc)
```

## Import new data

First, be sure that your data set is in the folder `data` with the extension `.rda`. This extension can be obtained by saving the data set as follow:

```{r, results='hide', eval=FALSE}
setwd("~/rbioacc/data")
save(mydata, file = "Lumbriculus_atrazine_240d_Jantunen2008.rda")
```

Then, add a data set named `mydata` (Lumbriculus_atrazine_240d_Jantunen2008) by using this command: `usethis::use_data(mydata)`.

```{r Lumbriculus, results='hide', eval=FALSE}
usethis::use_data(Lumbriculus_atrazine_240d_Jantunen2008)

data("Lumbriculus_atrazine_240d_Jantunen2008")
time_accumulation <- 240
data_MGM <- Lumbriculus_atrazine_240d_Jantunen2008[Lumbriculus_atrazine_240d_Jantunen2008$exps == 1.06, ]

modelData_MGM <- modelData(data_MGM, time_accumulation = 240)
```

## Simple example file

### Data

Load the data set with the function `data()`, define the duration of the exposure `time_accumulation`, and check if the data set is correctly imported with the function `modelData()`.

```{r }
data("Male_Gammarus_Single")
time_accumulation <- 4
modelData_MGS <- modelData(Male_Gammarus_Single, time_accumulation = 4)
```

### Inference

The function `fitTK()` performs the inference process.

```{r, results='hide', comments=FALSE, cache.comments=FALSE, cache=FALSE, message=FALSE, warning=FALSE}
fit <- fitTK(modelData_MGS, iter = 10000)
```

### Results

#### TK parameters

The 4 MCMC are stored in the object `fitMCMC`. The quantiles for each TK parameter can be obtained with the `quantile()` function.

```{r, warning=FALSE, message=FALSE}
library(rstan)
fitMCMC <- rstan::extract(fit)
quantile(fitMCMC$ku, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$ke, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$sigmaCpred, probs = c(0.025, 0.5, 0.975))
```

## Several exposure concentrations

### Example file `'Male_Gammarus_Merged`

If several exposure concentrations are available in the data set, you can select the exposure concentration on which you want to perform the analyses by creating the object `data_MGM`.

```{r merged}
data("Male_Gammarus_Merged")
data_MGM <- Male_Gammarus_Merged[Male_Gammarus_Merged$expw == 2.83208e-04, ]
modelData_MGM <- modelData(data_MGM, time_accumulation = 4)
```

```{r, results='hide', comments=FALSE, cache.comments=FALSE, cache=FALSE, message=FALSE, warning=FALSE}
fit <- fitTK(modelData_MGM, iter = 10000)
```

```{r, warning=FALSE, message=FALSE}
fitMCMC <- rstan::extract(fit)
quantile(fitMCMC$ku, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$ke, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$sigmaCpred, probs = c(0.025, 0.5, 0.975))
```

### Example file `Oncorhynchus_two`

```{r }
data("Oncorhynchus_two")
data_MGM <- Oncorhynchus_two[Oncorhynchus_two$expw == 0.00041, ]
modelData_MGM <- modelData(data_MGM, time_accumulation = 49)
```

```{r, results='hide', comments=FALSE, cache.comments=FALSE, cache=FALSE, message=FALSE, warning=FALSE}
fit <- fitTK(modelData_MGM, iter = 10000)
```

```{r, warning=FALSE, message=FALSE}
fitMCMC <- rstan::extract(fit)
quantile(fitMCMC$ku, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$ke, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$sigmaCpred, probs = c(0.025, 0.5, 0.975))
```

## With biotransformation

To do: how to remove Na (Inf) in data

### Example file `Male_Gammarus_seanine_growth`

```{r seanine}
data("Male_Gammarus_seanine_growth")
time_accumulation = 1.417
modelData_MGM = modelData(Male_Gammarus_seanine_growth, time_accumulation = 1.417)

fit <- fitTK(modelData_MGM, iter = 10000)

fitMCMC = rstan::extract(fit)
quantile(fitMCMC$ku, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$ke, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$sigmaCpred, probs = c(0.025, 0.5, 0.975))
```

### Example file `Chironomus_benzoapyrene`

```{r chiro}
data("Chironomus_benzoapyrene")

time_accumulation = 3
data_MGM = Chironomus_benzoapyrene[Chironomus_benzoapyrene$replicate == 1, ]
modelData_MGM = modelData(data_MGM, time_accumulation = 3)

fit <- fitTK(modelData_MGM, iter = 10000)

fitMCMC = rstan::extract(fit)
quantile(fitMCMC$ku, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$ke, probs = c(0.025, 0.5, 0.975))
quantile(fitMCMC$sigmaCpred, probs = c(0.025, 0.5, 0.975))
```
